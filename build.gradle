plugins {
    alias(libs.plugins.versions) apply false
    alias(libs.plugins.shadow) apply false
    alias(libs.plugins.errorprone) apply false
    alias(libs.plugins.nullaway) apply false
}

allprojects {
    group = 'com.groovy.lsp'
    version = '0.1.0-SNAPSHOT'
    
    repositories {
        mavenCentral()
        gradlePluginPortal()
        maven {
            url 'https://repo.gradle.org/gradle/libs-releases/'
        }
        maven {
            url 'https://groovy.jfrog.io/artifactory/libs-release-local'
        }
        maven {
            url 'https://repo.eclipse.org/releases/latest'
        }
    }
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'groovy'
    apply plugin: 'net.ltgt.errorprone'
    apply plugin: 'net.ltgt.nullaway'
    
    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(23)
        }
        // Temporarily disable module path to fix build issues
        modularity.inferModulePath = false
    }
    
    dependencies {
        implementation libs.groovy
        implementation libs.groovy.json
        implementation libs.groovy.xml
        implementation libs.groovy.nio
        implementation libs.groovy.templates
        implementation libs.slf4j.api
        implementation libs.logback.classic
        
        // Error Prone and NullAway
        errorprone libs.errorprone.core
        errorprone libs.nullaway
        
        testImplementation libs.junit.jupiter
        testImplementation libs.junit.jupiter.params
        testImplementation libs.mockk
        testImplementation libs.assertj.core
        testRuntimeOnly libs.junit.platform.launcher
    }
    
    test {
        useJUnitPlatform()
    }
    
    tasks.withType(JavaCompile) {
        options.errorprone {
            enabled = true
            disableWarningsInGeneratedCode = true
            
            // NullAway configuration
            check("NullAway", net.ltgt.gradle.errorprone.CheckSeverity.ERROR)
            option("NullAway:AnnotatedPackages", "com.groovy.lsp")
            option("NullAway:TreatGeneratedAsUnannotated", "true")
            option("NullAway:ExcludedFieldAnnotations", "org.mockito.Mock,org.mockito.Spy")
        }
    }
    
    tasks.withType(GroovyCompile) {
        options.encoding = 'UTF-8'
        groovyOptions.parameters = true
    }
    
    configurations.all {
        resolutionStrategy {
            capabilitiesResolution {
                withCapability('org.codehaus.groovy:groovy') {
                    selectHighestVersion()
                }
                withCapability('org.codehaus.groovy:groovy-json') {
                    selectHighestVersion()
                }
                withCapability('org.codehaus.groovy:groovy-xml') {
                    selectHighestVersion()
                }
                withCapability('org.codehaus.groovy:groovy-templates') {
                    selectHighestVersion()
                }
            }
            force 'org.apache.groovy:groovy:4.0.25'
            force 'org.apache.groovy:groovy-json:4.0.25'
            force 'org.apache.groovy:groovy-xml:4.0.25'
            force 'org.apache.groovy:groovy-nio:4.0.25'
            force 'org.apache.groovy:groovy-templates:4.0.25'
        }
    }
}