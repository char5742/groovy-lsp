plugins {
    id 'application'
    id 'com.github.johnrengelman.shadow'
}

dependencies {
    // Internal module dependencies
    implementation project(':shared')
    implementation project(':lsp-protocol')
    implementation project(':groovy-core')
    implementation project(':jdt-adapter')
    implementation project(':codenarc-lint')
    implementation project(':workspace-index')
    implementation project(':formatting')
    
    // LSP4J dependencies
    implementation libs.bundles.lsp4j
    
    // Guice for dependency injection
    implementation libs.guice
    
    // Logging
    implementation libs.bundles.logging
    
    // Error tracking
    implementation libs.sentry
}

application {
    mainClass = 'com.groovy.lsp.server.launcher.Main'
}

shadowJar {
    archiveBaseName = 'groovy-language-server'
    archiveClassifier = ''
    archiveVersion = project.version
    
    // Merge service files
    mergeServiceFiles()
    
    manifest {
        attributes(
            'Main-Class': 'com.groovy.lsp.server.launcher.Main',
            'Implementation-Title': 'Groovy Language Server',
            'Implementation-Version': project.version,
            'Built-By': System.getProperty('user.name'),
            'Built-Date': new Date().format('yyyy-MM-dd HH:mm:ss'),
            'Built-JDK': System.getProperty('java.version')
        )
    }
}

test {
    useJUnitPlatform()
}

// Task to run the server
task runServer(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.groovy.lsp.server.launcher.Main'
    standardInput = System.in
    standardOutput = System.out
    
    // JVM options for better performance
    jvmArgs = [
        '-Xms256m',
        '-Xmx2g',
        '-XX:+UseG1GC',
        '-XX:+UseStringDeduplication'
    ]
}