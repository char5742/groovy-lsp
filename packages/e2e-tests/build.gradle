plugins {
    id 'java'
}

// E2Eテスト専用のモジュールのため、JARは作成しない
jar {
    enabled = false
}

dependencies {
    // Server launcher for running the actual server
    testImplementation project(':server-launcher')

    // Test framework dependencies
    testImplementation libs.bundles.testing
    testImplementation libs.awaitility

    // Process management
    testImplementation 'org.zeroturnaround:zt-exec:1.12'
}

test {
    useJUnitPlatform()

    // E2Eテストの設定
    systemProperty 'e2e.test', 'true'
    systemProperty 'groovy.lsp.server.jar', project(':server-launcher').jar.archiveFile.get().asFile.absolutePath

    // テストのタイムアウト設定
    timeout = Duration.ofMinutes(15)

    // 並列実行を無効化
    maxParallelForks = 1

    testLogging {
        events 'started', 'passed', 'failed', 'skipped'
        exceptionFormat 'full'
        showStandardStreams = true
    }
}

// VS Code E2Eテストタスク
task vscodeE2ETest(type: Exec) {
    description = 'Runs VS Code E2E tests'
    group = 'verification'

    // Node.jsとnpmが必要
    commandLine 'npm', 'test'
    workingDir file('vscode-test')

    // 環境変数の設定
    environment 'GROOVY_LSP_JAR', project(':server-launcher').jar.archiveFile.get().asFile.absolutePath

    doFirst {
        // VS Codeテスト環境のセットアップを確認
        if (!file('vscode-test/node_modules').exists()) {
            throw new GradleException("VS Code test environment not set up. Run 'npm install' in vscode-test directory.")
        }
    }
}

// CIでのヘッドレステスト用タスク
task headlessE2ETest(type: Exec) {
    description = 'Runs E2E tests in headless mode (for CI)'
    group = 'verification'

    // xvfb-runを使用してヘッドレスモードで実行
    commandLine 'xvfb-run', '-a', 'npm', 'test'
    workingDir file('vscode-test')

    environment 'GROOVY_LSP_JAR', project(':server-launcher').jar.archiveFile.get().asFile.absolutePath
    environment 'CI', 'true'
}
