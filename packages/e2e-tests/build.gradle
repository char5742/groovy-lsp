// E2Eテストモジュール - VSCode拡張機能のE2Eテストのみを管理

// VS Code E2Eテストタスク
task vscodeE2ETest(type: Exec) {
    description = 'Runs VS Code E2E tests'
    group = 'verification'

    // Node.jsとnpmが必要
    commandLine 'npm', 'test'
    workingDir projectDir

    // 環境変数の設定
    environment 'GROOVY_LSP_JAR', project(':server-launcher').jar.archiveFile.get().asFile.absolutePath

    doFirst {
        // VS Codeテスト環境のセットアップを確認
        if (!file('node_modules').exists()) {
            throw new GradleException("VS Code test environment not set up. Run 'npm install' in e2e-tests directory.")
        }
    }
}

// CIでのヘッドレステスト用タスク
task headlessE2ETest(type: Exec) {
    description = 'Runs E2E tests in headless mode (for CI)'
    group = 'verification'

    // xvfb-runを使用してヘッドレスモードで実行
    commandLine 'xvfb-run', '-a', 'npm', 'test'
    workingDir projectDir

    environment 'GROOVY_LSP_JAR', project(':server-launcher').jar.archiveFile.get().asFile.absolutePath
    environment 'CI', 'true'
}
